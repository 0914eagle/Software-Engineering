<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title}, links=~{})">
	<title>Emergency Responder Home</title>
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
<div th:fragment="content">
	<script th:inline="javascript">
		var app = angular.module('emergencyResponderApp', []);

		app.controller('emergencyResponderController', function ($scope, $http) {
			$scope.searchTerm = '';
			$scope.patients = [];
			$scope.message = 'Welcome';
			$scope.showPatientDetails = false;

			$scope.search = function () {
				if (!$scope.searchTerm.trim()) {
					$scope.message = 'No data found. Please enter a search term.';
					$scope.patients = [];
				} else {
					$http.get('/iTrust2/api/v1/patientSearch', { params: { nameQuery: $scope.searchTerm } })
							.then(function (response) {
								$scope.patients = response.data;
								$scope.patients = filterPatients(response.data, $scope.searchTerm);
								if ($scope.patients.length === 0) {
									$scope.message = 'No data found for the given search term.';
								} else {
									$scope.message = '';
								}
							})
							.catch(function(rejection){
								$scope.message = 'Unable to get the patient data.';
								$scope.patients = [];
							});
				}
			};

			$scope.navigateToPatientDetail = function (patient) {
				$http.get('/iTrust2/api/v1/emergency/patients/' + patient.username)// + '?patientName=' + patient.username)
						.then(function (response) {
							$scope.selectedPatient = response.data;
							console.log(response.data);
							return $http.get('/iTrust2/api/v1/emergency/patients/' + patient.username + '/recentDiagnoses');
						})
						.then(function (response) {
							$scope.recentDiagnoses = response.data;
							return $http.get('/iTrust2/api/v1/emergency/patients/' + patient.username + '/recentPrescriptions');
						})
						.then(function (response) {
							$scope.recentPrescriptions = response.data;
							$scope.showPatientDetails = true;
						})
						.catch(function (rejection) {
							$scope.message = 'Unable to get detailed patient information.';
						});
			};

			function filterPatients(data, searchTerm) {
				return data.filter(function (patient) {
					return patient.username.includes(searchTerm) || patient.patientname.includes(searchTerm);
				});
			}
		});

		app.controller('PatientDetailController', function ($scope, $http, $routeParams) {
			var username = $routeParams.username;
			$scope.selectedPatient = {};
			$scope.recentDiagnoses = [];
			$scope.recentPrescriptions = [];

			$http.get('/iTrust2/api/v1/emergency/patients/' + username)
					.then(function (response) {
						$scope.selectedPatient = response.data;
					})
					.catch(function (rejection) {
						$scope.message = 'Unable to get detailed patient information.';
					});

			$http.get('/api/v1/emergency/patients/' + username + '/recentDiagnoses')
					.then(function (response) {
						$scope.recentDiagnoses = response.data;
					})
					.catch(function (rejection) {
						$scope.message = 'Unable to get recent diagnoses.';
					});

			$http.get('/api/v1/emergency/patients/' + username + '/recentPrescriptions')
					.then(function (response) {
						$scope.recentPrescriptions = response.data;
					})
					.catch(function (rejection) {
						$scope.message = 'Unable to get recent prescriptions.';
					});
		});
	</script>

	<div ng-app="emergencyResponderApp" ng-controller="emergencyResponderController">
		<h1>Welcome to iTrust2 - Emergency Responder</h1>

		<!-- Search bar and button -->
		<form>
			<input type="text" ng-model="searchTerm" placeholder="Enter your search term"/>
			<button type="button" ng-click="search()">Search</button>
		</form>

		<!-- Page states -->
		<p style="color: black">{{message}}</p>

		<!-- Table of Patients -->
		<table ng-if="patients.length > 0">
			<tr>
				<th>Username</th>
				<th>Patient Name</th>
				<th>Select</th>
			</tr>
			<tr ng-repeat="patient in patients">
				<td>{{patient.username}}</td>
				<td>{{patient.firstName + " " + patient.lastName}}</td>
				<td>
					<a ng-click="navigateToPatientDetail(patient)">
						Select
					</a>
				</td>
			</tr>
		</table>

		<!-- Patient Details -->
		<div ng-if="showPatientDetails">
			<h2>{{selectedPatient.firstName}} {{selectedPatient.lastName}}</h2>
			<p><strong>Username:</strong> {{selectedPatient.username}}</p>
			<p><strong>Name:</strong>{{selectedPatient.firstName}} {{selectedPatient.lastName}}</p>
			<p><strong>Age:</strong> {{selectedPatient.age}}</p>
			<p><strong>Date of birth:</strong>{{selectedPatient.dateOfBirth}}</p>
			<p><strong>Gender:</strong>{{selectedPatient.gender}}</p>
			<p><strong>Blood type:</strong> {{selectedPatient.bloodType}}</p>

			<!-- Display Recent Diagnoses -->
			<div ng-if="recentDiagnoses.length > 0">
				<h3>Recent Diagnoses</h3>
				<ul>
					<li ng-repeat="diagnosis in recentDiagnoses">{{diagnosis.id}}</li>
				</ul>
			</div>

			<!-- Display Recent Prescriptions -->
			<div ng-if="recentPrescriptions.length > 0">
				<h3>Recent Prescriptions</h3>
				<ul>
					<li ng-repeat="prescription in recentPrescriptions">{{prescription.id}}</li>
				</ul>
			</div>
		</div>
	</div>
</div>
</body>
</html>
